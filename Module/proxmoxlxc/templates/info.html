<style type="text/css" media="all">
    .border-left-warning {
        border-left: .25rem solid #f6c23e !important;
    }
    .border-left-info {
        border-left: .25rem solid #36b9cc !important;
    }
    .border-left-success {
        border-left: .25rem solid #1cc88a !important;
    }
    .border-left-primary {
        border-left: .25rem solid #4e73df !important;
    }
    .text-gray-300 {
        color: #dddfeb !important;
    }
    .shadow {
        box-shadow: 0 .15rem 1.75rem 0 rgba(58, 59, 69, .15) !important;
    }
    .fa-2x {
        font-size: 2em;
    }
    .no-gutters {
        margin-right: 0;
        margin-left: 0;
    }
    .card {
        margin-bottom: 1.5rem;
    }
</style>

<div class="row">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">处理器使用率</div>
                        <div class="row no-gutters align-items-center">
                            <div class="col">
                                <div class="progress progress-sm mr-2">
                                    <div class="progress-bar bg-primary" role="progressbar" id="cpu_jdt" style="width:0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <div class="h5 mt-1 font-weight-bold text-gray-800"><span id="cpu_usage">0</span>% (<span id="cpu_cores">0</span> 核心)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">内存使用率 (<span id="mem_percent">0</span>%)</div>
                        <div class="row no-gutters align-items-center">
                            <div class="col">
                                <div class="progress progress-sm mr-2">
                                    <div class="progress-bar bg-success" role="progressbar" id="mem_jdt" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <div class="h5 mt-1 font-weight-bold text-gray-800"><span id="mem_used">0</span> MB / <span id="mem_total">0</span> MB</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">磁盘占用率 (<span id="disk_percent">0</span>%)</div>
                         <div class="row no-gutters align-items-center">
                            <div class="col">
                                <div class="progress progress-sm mr-2">
                                    <div class="progress-bar bg-info" role="progressbar" id="disk_jdt" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <div class="h5 mb-0 mt-1 font-weight-bold text-gray-800"><span id="disk_used">0</span> GB / <span id="disk_total">0</span> GB</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">已正常运行</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="uptime">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">LXC容器信息</h6>
    </div>
    <div class="card-body">
        <p class="mb-0">
            VMID：<span id="info_vmid">{$vmid}</span><br>
            节点：<span id="info_node">{$node}</span><br>
            主机名：<span id="info_hostname">加载中...</span><br>
            状态：<span id="info_status">加载中...</span><br>
        </p>
    </div>
</div>

<script type="text/javascript" charset="utf-8">
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function formatUptime(seconds) {
        if (isNaN(seconds) || seconds < 0) {
            return "未知";
        }
        let d = Math.floor(seconds / (3600*24));
        let h = Math.floor(seconds % (3600*24) / 3600);
        let m = Math.floor(seconds % 3600 / 60);
        let s = Math.floor(seconds % 60);

        let dDisplay = d > 0 ? d + (d == 1 ? " 天, " : " 天, ") : "";
        let hDisplay = h > 0 ? h + (h == 1 ? " 小时, " : " 小时, ") : "";
        let mDisplay = m > 0 ? m + (m == 1 ? " 分钟, " : " 分钟, ") : "";
        let sDisplay = s > 0 ? s + (s == 1 ? " 秒" : " 秒") : "0 秒";
        if (d === 0 && h === 0 && m === 0 && s === 0 && seconds > 0) return seconds.toFixed(0) + " 秒"; // for very short uptimes
        if (d === 0 && h === 0 && m === 0 && s === 0 && seconds === 0) return "0 秒";

        let result = dDisplay + hDisplay + mDisplay + sDisplay;
        return result.replace(/, $/,'');
    }

    function updateContainerInfo() {
        var body = {"func": "GetContainerStatus"};
        $.post("{$MODULE_CUSTOM_API}", body, function(response) { // Changed 'data' to 'response' to avoid conflict
            if (response && response.status === 'success' && response.data) {
                var statusData = response.data;
                $('#info_hostname').text(statusData.name || 'N/A');
                $('#info_status').text(statusData.status || 'N/A');

                var cpuUsage = parseFloat(statusData.cpu || 0) * 100;
                $('#cpu_usage').text(cpuUsage.toFixed(2));
                $('#cpu_jdt').css('width', cpuUsage.toFixed(0) + '%').attr('aria-valuenow', cpuUsage.toFixed(0));
                $('#cpu_cores').text(statusData.cpus || 'N/A');


                var memUsed = parseInt(statusData.mem || 0);
                var memTotal = parseInt(statusData.maxmem || 1); // Ensure maxmem is not 0 to avoid division by zero
                var memPercent = memTotal > 0 ? (memUsed / memTotal * 100) : 0;
                $('#mem_used').text(formatBytes(memUsed,0));
                $('#mem_total').text(formatBytes(memTotal,0));
                $('#mem_percent').text(memPercent.toFixed(2));
                $('#mem_jdt').css('width', memPercent.toFixed(0) + '%').attr('aria-valuenow', memPercent.toFixed(0));
                
                var diskUsed = parseInt(statusData.disk || 0);
                var diskTotal = parseInt(statusData.maxdisk || 1); // Ensure maxdisk is not 0
                var diskPercent = diskTotal > 0 ? (diskUsed / diskTotal * 100) : 0;

                $('#disk_used').text(formatBytes(diskUsed,1));
                $('#disk_total').text(formatBytes(diskTotal,1));
                $('#disk_percent').text(diskPercent.toFixed(2));
                $('#disk_jdt').css('width', diskPercent.toFixed(0) + '%').attr('aria-valuenow', diskPercent.toFixed(0));


                $('#uptime').text(formatUptime(statusData.uptime || 0));
            } else {
                $('#info_hostname').text('获取失败');
                $('#info_status').text('获取失败: ' + (response.msg || ''));
            }
        }).fail(function(){
            $('#info_hostname').text('请求失败');
            $('#info_status').text('请求失败');
        });
    }
    $(document).ready(function() {
        updateContainerInfo();
        setInterval(updateContainerInfo, 5000); // Refresh every 5 seconds
    });
</script>
