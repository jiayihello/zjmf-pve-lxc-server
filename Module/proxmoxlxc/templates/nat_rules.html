<style>
    .proxmoxlxc-nat-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        max-width: 900px;
        margin: 20px auto;
    }
    .proxmoxlxc-nat-header {
        font-size: 1.5em;
        color: #333;
        margin-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 10px;
    }
    .proxmoxlxc-nat-form-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 25px;
        border: 1px solid #e9ecef;
    }
    .proxmoxlxc-nat-form-group {
        margin-bottom: 15px;
    }
    .proxmoxlxc-nat-form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
    }
    .proxmoxlxc-nat-form-control {
        display: block;
        width: 100%;
        padding: 10px;
        font-size: 14px;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 4px;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        box-sizing: border-box;
    }
    .proxmoxlxc-nat-form-control:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 .2rem rgba(0,123,255,.25);
    }
    .proxmoxlxc-nat-btn {
        display: inline-block;
        font-weight: 400;
        color: #fff;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        background-color: #007bff;
        border: 1px solid #007bff;
        padding: 10px 15px;
        font-size: 14px;
        line-height: 1.5;
        border-radius: 4px;
        transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        user-select: none;
    }
    .proxmoxlxc-nat-btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    .proxmoxlxc-nat-btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    .proxmoxlxc-nat-btn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .proxmoxlxc-nat-btn-xs {
        padding: 5px 10px;
        font-size: 12px;
        line-height: 1.5;
        border-radius: 3px;
    }
    .proxmoxlxc-nat-alert {
        position: relative;
        padding: 12px 20px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
        font-size: 14px;
    }
    .proxmoxlxc-nat-alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .proxmoxlxc-nat-alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .proxmoxlxc-nat-alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
    .proxmoxlxc-nat-alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }
    .proxmoxlxc-nat-table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .proxmoxlxc-nat-table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
        border-collapse: collapse;
    }
    .proxmoxlxc-nat-table th,
    .proxmoxlxc-nat-table td {
        padding: 12px;
        vertical-align: top;
        border-top: 1px solid #dee2e6;
        font-size: 14px;
    }
    .proxmoxlxc-nat-table thead th {
        vertical-align: bottom;
        border-bottom: 2px solid #dee2e6;
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 500;
    }
    .proxmoxlxc-nat-table tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.03);
    }
    .proxmoxlxc-nat-label {
        display: inline-block;
        padding: .3em .6em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: .25rem;
    }
    .proxmoxlxc-nat-label-success { background-color: #28a745; }
    .proxmoxlxc-nat-label-danger { background-color: #dc3545; }

    @media (max-width: 768px) {
        .proxmoxlxc-nat-header { font-size: 1.3em; }
        .proxmoxlxc-nat-btn { width: 100%; margin-top: 5px; }
        .proxmoxlxc-nat-btn-xs { width: auto; }
        .proxmoxlxc-nat-form-group { margin-bottom: 10px; }
         .proxmoxlxc-nat-table th, .proxmoxlxc-nat-table td { padding: 8px; font-size: 13px; }
    }
</style>

<div class="proxmoxlxc-nat-container">
    <h3 class="proxmoxlxc-nat-header">NAT规则管理</h3>
    <p class="proxmoxlxc-nat-alert proxmoxlxc-nat-alert-warning"><strong>注意:</strong> 此处添加的规则将尝试获取容器当前IP进行配置。如果容器IP地址发生变化 (例如DHCP租约更新)，规则可能需要重新应用或手动调整。</p>

    <div class="proxmoxlxc-nat-form-section">
        <h4>添加新规则</h4>
        <form id="proxmoxlxcAddNatRuleForm" onsubmit="proxmoxlxcSubmitNatForm(event, 'proxmoxlxcAddNatRuleForm', 'createnatrule');">
            <div class="proxmoxlxc-nat-form-group">
                <label for="proxmoxlxc_host_port">主机端口:</label>
                <input type="number" class="proxmoxlxc-nat-form-control" id="proxmoxlxc_host_port" name="host_port" required min="1" max="65535" placeholder="例如: 8080">
            </div>
            <div class="proxmoxlxc-nat-form-group">
                <label for="proxmoxlxc_container_port">容器端口:</label>
                <input type="number" class="proxmoxlxc-nat-form-control" id="proxmoxlxc_container_port" name="container_port" required min="1" max="65535" placeholder="例如: 80">
            </div>
            <div class="proxmoxlxc-nat-form-group">
                <label for="proxmoxlxc_protocol">协议:</label>
                <select class="proxmoxlxc-nat-form-control" id="proxmoxlxc_protocol" name="protocol">
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>
            <div class="proxmoxlxc-nat-form-group">
                <label for="proxmoxlxc_description">描述 (可选):</label>
                <input type="text" class="proxmoxlxc-nat-form-control" id="proxmoxlxc_description" name="description" maxlength="200" placeholder="例如: 网站访问">
            </div>
            <button type="submit" class="proxmoxlxc-nat-btn">添加规则</button>
            <div id="proxmoxlxcAddNatRuleFormMessage" style="margin-top:10px;"></div>
        </form>
    </div>

    <h4>现有规则</h4>
    <?php if (!empty($error_message_rules)): ?>
        <div class='proxmoxlxc-nat-alert proxmoxlxc-nat-alert-danger'>加载规则失败: <?php echo $error_message_rules; ?></div>
    <?php elseif (empty($rules)): ?>
        <p class="proxmoxlxc-nat-alert proxmoxlxc-nat-alert-info">当前没有NAT规则。</p>
    <?php else: ?>
    <div class="proxmoxlxc-nat-table-responsive">
        <table class="proxmoxlxc-nat-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>主机端口</th>
                    <th>容器IP:端口</th>
                    <th>协议</th>
                    <th>描述</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
            <?php foreach ($rules as $rule): ?>
                <?php $rule_id_js = htmlspecialchars($rule['id'] ?? '', ENT_QUOTES); ?>
                <?php $enabledText = ($rule['enabled'] ?? false) ? '<span class="proxmoxlxc-nat-label proxmoxlxc-nat-label-success">已启用</span>' : '<span class="proxmoxlxc-nat-label proxmoxlxc-nat-label-danger">已禁用</span>'; ?>
                <tr>
                    <td><?php echo htmlspecialchars($rule['id'] ?? 'N/A', ENT_QUOTES); ?></td>
                    <td><?php echo htmlspecialchars($rule['host_port'] ?? 'N/A', ENT_QUOTES); ?></td>
                    <td><?php echo htmlspecialchars($rule['container_ip_at_creation'] ?? 'N/A', ENT_QUOTES); ?>:<?php echo htmlspecialchars($rule['container_port'] ?? 'N/A', ENT_QUOTES); ?></td>
                    <td><?php echo strtoupper(htmlspecialchars($rule['protocol'] ?? 'N/A', ENT_QUOTES)); ?></td>
                    <td><?php echo htmlspecialchars($rule['description'] ?? '', ENT_QUOTES); ?></td>
                    <td><?php echo $enabledText; ?></td>
                    <td><?php
                        $date = new DateTime($rule['created_at'] ?? 'now');
                        echo htmlspecialchars($date->format('Y-m-d H:i:s'), ENT_QUOTES);
                    ?></td>
                    <td>
                        <form id='proxmoxlxcDeleteNatRuleForm_<?php echo $rule_id_js; ?>' style='display:inline;' onsubmit="proxmoxlxcSubmitNatForm(event, 'proxmoxlxcDeleteNatRuleForm_<?php echo $rule_id_js; ?>', 'deletenatrule');">
                            <input type='hidden' name='rule_id' value='<?php echo $rule_id_js; ?>'>
                            <button type='submit' class='proxmoxlxc-nat-btn proxmoxlxc-nat-btn-danger proxmoxlxc-nat-btn-xs'>删除</button>
                        </form>
                        <div id='proxmoxlxcDeleteNatRuleForm_<?php echo $rule_id_js; ?>Message' style='margin-top:5px; font-size:0.9em;'></div>
                    </td>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    <?php endif; ?>
</div>

<script>
function proxmoxlxcGetCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function proxmoxlxcEscapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return String(unsafe);
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

function proxmoxlxcHandleApiResponse(formId, responseText) {
    const messageDivId = formId + 'Message';
    const messageDiv = document.getElementById(messageDivId);
    if (!messageDiv) { console.error('Message div not found: ' + messageDivId); return; }
    
    let res = {};
    try {
        res = JSON.parse(responseText);
    } catch (e) {
        messageDiv.innerHTML = '<div class="proxmoxlxc-nat-alert proxmoxlxc-nat-alert-danger">响应解析错误: ' + proxmoxlxcEscapeHtml(e.message) + '</div>';
        console.error("Raw response causing parse error: ", responseText);
        return;
    }

    if (res.status === 'success') {
        messageDiv.innerHTML = '<div class="proxmoxlxc-nat-alert proxmoxlxc-nat-alert-success">' + (res.msg ? proxmoxlxcEscapeHtml(res.msg) : '操作成功') + '</div>';
        if (formId.startsWith('proxmoxlxcDeleteNatRuleForm_') || formId === 'proxmoxlxcAddNatRuleForm') {
            setTimeout(() => window.location.reload(), 1500);
        }
    } else {
        messageDiv.innerHTML = '<div class="proxmoxlxc-nat-alert proxmoxlxc-nat-alert-danger">' + (res.msg ? proxmoxlxcEscapeHtml(res.msg) : '操作失败: ' + proxmoxlxcEscapeHtml(responseText) ) + '</div>';
    }
}

function proxmoxlxcSubmitNatForm(event, formId, funcName) {
    event.preventDefault();
    const form = document.getElementById(formId);
    const formData = form ? new FormData(form) : new FormData();
    
    const messageDivId = formId + 'Message';
    const messageDiv = document.getElementById(messageDivId);
    if(messageDiv) messageDiv.innerHTML = '<div class="proxmoxlxc-nat-alert proxmoxlxc-nat-alert-info">处理中...</div>';

    const fetchUrl = '<?php echo $js_module_custom_api_url; ?>&func=' + funcName;
    
    const zjmfJwtToken = proxmoxlxcGetCookie('ZJMF_474FFBE2DC4BDFD9');

    const requestHeaders = {};

    if (zjmfJwtToken) {
        requestHeaders['Authorization'] = 'Bearer ' + zjmfJwtToken;
    } else {
        console.warn('ZJMF JWT cookie not found. Request might fail if auth is required.');
    }
    
    const urlEncodedData = new URLSearchParams();
    for (const pair of formData) {
        urlEncodedData.append(pair[0], pair[1]);
    }

    fetch(fetchUrl, {
        method: 'POST',
        body: urlEncodedData,
        headers: {
            ...requestHeaders,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                 try {
                    const errorJson = JSON.parse(text);
                    throw new Error(errorJson.msg || errorJson.message || `HTTP ${response.status}: ${text.substring(0,100)}`);
                 } catch (e) {
                    let detailError = text.substring(0, 200);
                     if (text.toLowerCase().includes('<html')) {
                         detailError = "服务器返回了HTML错误页面，请检查API配置或联系管理员。";
                     }
                    throw new Error(`HTTP ${response.status}. ${detailError}`);
                 }
            });
        }
        return response.text();
    })
    .then(text => proxmoxlxcHandleApiResponse(formId, text))
    .catch(error => {
        if(messageDiv) messageDiv.innerHTML = '<div class="proxmoxlxc-nat-alert proxmoxlxc-nat-alert-danger">请求错误: ' + proxmoxlxcEscapeHtml(error.message) + '</div>';
        console.error('Fetch error for ' + funcName + ':', error);
    });
}
</script>
