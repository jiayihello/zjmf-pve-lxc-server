<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">快照管理</h6>
        <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#createSnapshotModal">创建快照</button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="snapshotTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>快照名称</th>
                        <th>描述</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="text-center">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="createSnapshotModal" tabindex="-1" role="dialog" aria-labelledby="createSnapshotModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createSnapshotModalLabel">创建新快照</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="snapshotNameInput">快照名称</label>
                    <input type="text" class="form-control" id="snapshotNameInput" placeholder="例如：my_snapshot_1">
                </div>
                <div class="form-group">
                    <label for="snapshotDescriptionInput">描述 (可选)</label>
                    <textarea class="form-control" id="snapshotDescriptionInput" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="handleCreateSnapshot()">创建</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function loadSnapshots() {
        var body = {"func": "GetSnapshots"};
        var tbody = $('#snapshotTable tbody');
        tbody.html('<tr><td colspan="4" class="text-center">加载中...</td></tr>');

        $.post("{$MODULE_CUSTOM_API}", body, function(response) { // Changed 'data' to 'response'
            tbody.empty();
            // Backend returns a list of snapshots directly in response.data
            if (response && response.status === 'success' && Array.isArray(response.data) && response.data.length > 0) {
                var hasActualSnapshots = false;
                $.each(response.data, function(index, snapshot) {
                    if (snapshot.name === 'current') return; // Skip 'current' state entry if PVE includes it
                    hasActualSnapshots = true;
                    var snapTime = snapshot.snaptime ? new Date(snapshot.snaptime * 1000).toLocaleString() : (snapshot.time ? new Date(snapshot.time * 1000).toLocaleString() : '-'); // PVE might use 'time' or 'snaptime'
                    var row = '<tr>' +
                        '<td>' + escapeHtml(snapshot.name) + '</td>' +
                        '<td>' + escapeHtml(snapshot.description || '-') + '</td>' +
                        '<td>' + snapTime + '</td>' +
                        '<td>' +
                            '<button class="btn btn-info btn-sm mr-1" onclick="handleRollbackSnapshot(\'' + escapeHtml(snapshot.name) + '\')">回滚</button>' +
                            '<button class="btn btn-danger btn-sm" onclick="handleDeleteSnapshot(\'' + escapeHtml(snapshot.name) + '\')">删除</button>' +
                        '</td>' +
                        '</tr>';
                    tbody.append(row);
                });
                 if (!hasActualSnapshots) {
                    tbody.html('<tr><td colspan="4" class="text-center">没有可用的快照。</td></tr>');
                }
            } else if (response && response.status === 'success' && (!response.data || response.data.length === 0)) {
                 tbody.html('<tr><td colspan="4" class="text-center">没有可用的快照。</td></tr>');
            }
            else {
                tbody.html('<tr><td colspan="4" class="text-center">获取快照列表失败: ' + (response.msg || '未知错误') + '</td></tr>');
            }
        }).fail(function() {
            tbody.html('<tr><td colspan="4" class="text-center">请求快照列表时发生错误。</td></tr>');
        });
    }

    function handleCreateSnapshot() {
        var snapName = $('#snapshotNameInput').val();
        var snapDesc = $('#snapshotDescriptionInput').val();
        if (!snapName) {
            Swal.fire('错误', '快照名称不能为空。', 'error');
            return;
        }
        $('#createSnapshotModal').modal('hide');
        showLoading('正在创建快照...');
        var body = {"func": "CreateSnapshot", "snapname": snapName, "description": snapDesc};
        $.post("{$MODULE_CUSTOM_API}", body, function(response) { // Changed 'data' to 'response'
            // PHP returns {'status':'success', 'data': {'task_upid': 'UPID...'}}
            if (response && response.status === 'success' && response.data && response.data.task_upid) {
                 monitorTask(response.data.task_upid, '快照创建成功！', '创建快照失败', function(){
                    loadSnapshots();
                    $('#snapshotNameInput').val('');
                    $('#snapshotDescriptionInput').val('');
                 });
            } else {
                hideLoading();
                Swal.fire('失败', '创建快照失败: ' + (response.msg || '未知错误'), 'error');
            }
        }).fail(function() {
            hideLoading();
            Swal.fire('失败', '创建快照请求失败。', 'error');
        });
    }

    function handleRollbackSnapshot(snapName) {
        Swal.fire({
            title: '确认回滚?',
            text: "确定要回滚到快照 '" + escapeHtml(snapName) + "' 吗？当前容器状态将会丢失。",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '确认回滚',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading('正在回滚快照...');
                var body = {"func": "RollbackSnapshot", "snapname": snapName};
                $.post("{$MODULE_CUSTOM_API}", body, function(response) { // Changed 'data' to 'response'
                     if (response && response.status === 'success' && response.data && response.data.task_upid) {
                         monitorTask(response.data.task_upid, '快照回滚成功！容器可能需要手动启动。', '快照回滚失败');
                    } else {
                        hideLoading();
                        Swal.fire('失败', '快照回滚失败: ' + (response.msg || '未知错误'), 'error');
                    }
                }).fail(function() {
                    hideLoading();
                    Swal.fire('失败', '快照回滚请求失败。', 'error');
                });
            }
        });
    }

    function handleDeleteSnapshot(snapName) {
        Swal.fire({
            title: '确认删除?',
            text: "确定要删除快照 '" + escapeHtml(snapName) + "' 吗？此操作不可恢复。",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '确认删除',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading('正在删除快照...');
                var body = {"func": "DeleteSnapshot", "snapname": snapName};
                $.post("{$MODULE_CUSTOM_API}", body, function(response) { // Changed 'data' to 'response'
                     if (response && response.status === 'success' && response.data && response.data.task_upid) {
                         monitorTask(response.data.task_upid, '快照删除成功！', '删除快照失败', loadSnapshots);
                    } else {
                        hideLoading();
                        Swal.fire('失败', '删除快照失败: ' + (response.msg || '未知错误'), 'error');
                    }
                }).fail(function() {
                    hideLoading();
                    Swal.fire('失败', '删除快照请求失败。', 'error');
                });
            }
        });
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || typeof unsafe === 'undefined') {
            return '';
        }
        return unsafe
             .toString()
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }
    
    function showLoading(title) {
        Swal.fire({
            title: title,
            html: '请稍候...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function hideLoading() {
        Swal.close();
    }

    function monitorTask(taskId, successMessage, errorMessage, callback) {
        showLoading('正在执行操作 (任务ID: ' + escapeHtml(taskId.substring(0,30)) + '...)'); // Show task ID in loading
        var checkInterval = setInterval(function() {
            var body = {"func": "GetTaskStatus", "task_id": taskId};
            $.post("{$MODULE_CUSTOM_API}", body, function(taskResponse) { // Changed 'taskData' to 'taskResponse'
                // PHP returns {'status':'success', 'data': { PVE TaskStatus object } }
                if (taskResponse && taskResponse.status === 'success' && taskResponse.data) {
                    var taskData = taskResponse.data; // Actual PVE TaskStatus
                    if (taskData.status === 'stopped') {
                        clearInterval(checkInterval);
                        hideLoading();
                        if (taskData.exitstatus === 'OK') {
                            Swal.fire('成功', successMessage, 'success');
                            if (callback) callback();
                        } else {
                            Swal.fire('失败', errorMessage + (taskData.exitstatus ? ' (错误: ' + escapeHtml(taskData.exitstatus) + ')' : ''), 'error');
                        }
                    } else if (taskData.status === 'error') { // Should not happen if taskData.status is 'stopped'
                         clearInterval(checkInterval);
                         hideLoading();
                         Swal.fire('失败', errorMessage + ' (任务报告错误状态)', 'error');
                    }
                    // If still running, keep polling, loading indicator is already shown.
                } else {
                    clearInterval(checkInterval);
                    hideLoading();
                    Swal.fire('警告', '无法追踪任务状态。请稍后刷新查看。(' + (taskResponse.msg || '无详细信息') + ')', 'warning');
                }
            }).fail(function() {
                clearInterval(checkInterval);
                hideLoading();
                Swal.fire('警告', '检查任务状态时请求失败。', 'warning');
            });
        }, 3000);
    }


    $(document).ready(function() {
        loadSnapshots();
    });
</script>
