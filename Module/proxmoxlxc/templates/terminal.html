<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-attach@0.9.0/lib/xterm-addon-attach.js"></script>

<style>
    .proxmoxlxc-terminal-controls {
        margin-bottom: 10px;
    }
    .proxmoxlxc-terminal-btn {
        display: inline-block;
        font-weight: 400;
        color: #fff;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        background-color: #007bff;
        border: 1px solid #007bff;
        padding: 8px 12px;
        font-size: 14px;
        line-height: 1.5;
        border-radius: 4px;
        transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        user-select: none;
    }
    .proxmoxlxc-terminal-btn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .proxmoxlxc-terminal-btn:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
    }
    .proxmoxlxc-terminal-container {
        width: 100%;
        height: 500px;
        background-color: #1e1e1e;
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #proxmoxlxc_terminal {
        width: 100%;
        height: 100%;
    }
    .proxmoxlxc-terminal-status {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
    }
    .proxmoxlxc-terminal-status-default { background-color: #e9ecef; color: #495057; border: 1px solid #ced4da;}
    .proxmoxlxc-terminal-status-connecting { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}
    .proxmoxlxc-terminal-status-connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
    .proxmoxlxc-terminal-status-disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
    .proxmoxlxc-terminal-status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
</style>

<div class="proxmoxlxc-terminal-controls">
    <button id="proxmoxlxc_connect_btn" class="proxmoxlxc-terminal-btn">连接终端</button>
</div>
<div id="proxmoxlxc_terminal_status_area">
    <?php if (!empty($error_message_terminal)): ?>
        <div class="proxmoxlxc-terminal-status proxmoxlxc-terminal-status-error"><?php echo htmlspecialchars($error_message_terminal); ?></div>
    <?php else: ?>
        <div class="proxmoxlxc-terminal-status proxmoxlxc-terminal-status-default">点击“连接终端”按钮以启动。</div>
    <?php endif; ?>
</div>
<div class="proxmoxlxc-terminal-container">
    <div id="proxmoxlxc_terminal"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const terminalContainer = document.getElementById('proxmoxlxc_terminal');
    const statusArea = document.getElementById('proxmoxlxc_terminal_status_area');
    const connectButton = document.getElementById('proxmoxlxc_connect_btn');
    let term;
    let socket;
    let fitAddon;

    const productId = '<?php echo $product_id; ?>';
    const customApiUrl = '<?php echo $js_module_custom_api_url; ?>';
    const vmid = '<?php echo $vmid; ?>';
    const node = '<?php echo $node; ?>';
    const jwtTokenFromPhp = '<?php echo $jwt_token; ?>';


    function updateStatus(message, type = 'default') {
        let className = 'proxmoxlxc-terminal-status-default';
        if (type === 'connecting') className = 'proxmoxlxc-terminal-status-connecting';
        else if (type === 'connected') className = 'proxmoxlxc-terminal-status-connected';
        else if (type === 'disconnected') className = 'proxmoxlxc-terminal-status-disconnected';
        else if (type === 'error') className = 'proxmoxlxc-terminal-status-error';
        
        statusArea.innerHTML = `<div class="proxmoxlxc-terminal-status ${className}">${proxmoxlxcEscapeHtml(message)}</div>`;
    }
    
    function proxmoxlxcEscapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return String(unsafe);
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function proxmoxlxcGetCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function initTerminal(wsUrl, ticket) {
        if (!terminalContainer) {
            updateStatus('终端容器DIV元素未找到。', 'error');
            connectButton.disabled = false;
            return;
        }
        if (term) { 
            term.dispose();
        }
        if (socket && socket.readyState !== WebSocket.CLOSED) {
            socket.close();
        }

        term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Consolas, "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#cccccc',
                cursor: '#cccccc',
            },
            rows: 24, 
            cols: 80
        });

        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(terminalContainer);
        
        try {
            fitAddon.fit(); 
        } catch (e) {
        }

        window.addEventListener('resize', () => {
            try {
                if (fitAddon && term && terminalContainer.offsetParent !== null) { 
                     fitAddon.fit();
                }
            } catch (e) {
            }
        });
        
        updateStatus(`正在连接到 WebSocket: ${wsUrl.split('?')[0]}...`, 'connecting');
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            updateStatus('WebSocket 连接成功，正在发送票据...', 'connecting');
            
            socket.send(ticket); 

            const attachAddon = new AttachAddon.AttachAddon(socket);
            term.loadAddon(attachAddon); 

            updateStatus('终端已连接。', 'connected');
            connectButton.textContent = '断开连接';
            connectButton.disabled = false;
            term.focus();
             try {
                fitAddon.fit(); 
            } catch (e) {
            }
        };

        socket.onerror = function(event) {
            let errorDetail = event.type || '未知错误';
            try {
                const eventStr = JSON.stringify(event);
                if(eventStr.length > 2) errorDetail = eventStr.substring(0, 100);
            } catch(e) {}

            updateStatus(`WebSocket连接错误: ${errorDetail}`, 'error');
            if(term) term.write('\r\n\x1b[31mWebSocket 连接错误。\x1b[0m\r\n');
            connectButton.textContent = '连接终端';
            connectButton.disabled = false;
        };

        socket.onclose = function(event) {
            let reason = '';
            if (event.code) reason += `代码: ${event.code}`;
            if (event.reason) reason += (reason ? ', ' : '') + `原因: ${proxmoxlxcEscapeHtml(event.reason)}`;
            if (!reason) reason = '连接已关闭。';
            
            updateStatus(`终端已断开: ${reason}`, 'disconnected');
            if(term && term.textarea) { 
                 term.write(`\r\n\x1b[33mWebSocket 连接已关闭 (${reason}).\x1b[0m\r\n`);
            }
            connectButton.textContent = '连接终端';
            connectButton.disabled = false;
        };
    }

    function disconnectTerminal() {
        if (socket && socket.readyState !== WebSocket.CLOSED) {
            socket.close();
        }
        if (term) {
            term.dispose();
            term = null;
        }
        updateStatus('已断开连接。点击“连接终端”按钮以重新连接。', 'default');
        connectButton.textContent = '连接终端';
        connectButton.disabled = false;
    }

    function startConnectionProcess() {
        connectButton.disabled = true;
        connectButton.textContent = '连接中...';
        updateStatus('正在获取连接信息...', 'connecting');

        const fetchUrl = `${customApiUrl}&func=getterminalticket&product_id=${productId}&vmid=${encodeURIComponent(vmid)}&node=${encodeURIComponent(node)}&jwt=${encodeURIComponent(jwtTokenFromPhp)}`;
        
        const zjmfClientAreaJwtToken = proxmoxlxcGetCookie('ZJMF_CLIENTAREA_AUTH_TOKEN'); 
        const requestHeaders = {};

        if (zjmfClientAreaJwtToken) {
            requestHeaders['Authorization'] = 'Bearer ' + zjmfClientAreaJwtToken;
        } else if (jwtTokenFromPhp) {
            requestHeaders['Authorization'] = 'Bearer ' + jwtTokenFromPhp;
        }


        fetch(fetchUrl, {
            method: 'GET', 
            headers: requestHeaders
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { 
                    try {
                        const errorJson = JSON.parse(text);
                        throw new Error(errorJson.msg || errorJson.message || `HTTP ${response.status}: 获取票据失败`);
                    } catch(e){
                         throw new Error(`HTTP ${response.status}: ${text.substring(0,100)}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' && data.ws_url && data.ticket) {
                initTerminal(data.ws_url, data.ticket);
            } else {
                const errorMsg = data.msg || '从服务器获取终端信息失败。';
                updateStatus(errorMsg, 'error');
                connectButton.textContent = '连接终端';
                connectButton.disabled = false;
            }
        })
        .catch(error => {
            updateStatus(`初始化终端时出错: ${error.message}`, 'error');
            connectButton.textContent = '连接终端';
            connectButton.disabled = false;
        });
    }

    if (connectButton) {
        connectButton.addEventListener('click', function() {
            if (this.textContent === '断开连接') {
                disconnectTerminal();
            } else {
                startConnectionProcess();
            }
        });
    } else {
        updateStatus("无法找到连接按钮。", "error");
    }
});
</script>
