<div class="row">
    <div class="col-lg-7 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">服务器实时状态</h6>
            </div>
            <div class="card-body">
                <div id="server_status_loading_info">正在加载状态... <i class="fas fa-spinner fa-spin"></i></div>
                <div id="server_status_content_info" style="display:none;">
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>VMID:</strong></div>
                        <div class="col-sm-8"><span id="info_vmid_val">N/A</span></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>主机名/标签:</strong></div>
                        <div class="col-sm-8"><span id="info_name_val">N/A</span></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>所在节点:</strong></div>
                        <div class="col-sm-8"><span id="info_node_val">N/A</span></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>当前状态:</strong></div>
                        <div class="col-sm-8"><span id="info_status_text_val" class="font-weight-bold">N/A</span></div>
                    </div>
                    <hr>
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>CPU 使用率:</strong></div>
                        <div class="col-sm-8"><span id="info_cpu_usage_val">0.00</span>%</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>内存使用:</strong></div>
                        <div class="col-sm-8">
                            <span id="info_mem_usage_val">0</span> MB / <span id="info_mem_max_val">0</span> MB
                            (<span id="info_mem_percent_val">0.00</span>%)
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>SWAP使用:</strong></div>
                        <div class="col-sm-8">
                            <span id="info_swap_usage_val">0</span> MB / <span id="info_swap_max_val">0</span> MB
                            (<span id="info_swap_percent_val">0.00</span>%)
                        </div>
                    </div>
                     <div class="row mb-2">
                        <div class="col-sm-4"><strong>磁盘使用 (系统盘):</strong></div>
                        <div class="col-sm-8">
                            <span id="info_disk_usage_val">0</span> GB / <span id="info_disk_max_val">0</span> GB
                            (<span id="info_disk_percent_val">0.00</span>%)
                        </div>
                    </div>
                    <hr>
                    <div class="row mb-2">
                        <div class="col-sm-4"><strong>持续运行时长:</strong></div>
                        <div class="col-sm-8"><span id="info_uptime_val">N/A</span></div>
                    </div>
                </div>
                 <button class="btn btn-sm btn-info mt-3" onclick="refreshServerStatusInfoPage()">
                     <i class="fas fa-sync-alt"></i> 刷新状态
                 </button>
            </div>
        </div>
    </div>
    <div class="col-lg-5 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">产品基本配置</h6>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>CPU核心:</strong></div>
                    <div class="col-sm-7">{$params.configoptions_upgrade.cpu} 核</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>内存配额:</strong></div>
                    <div class="col-sm-7">{$params.configoptions_upgrade.memory} MB</div>
                </div>
                 <div class="row mb-2">
                    <div class="col-sm-5"><strong>SWAP配额:</strong></div>
                    <div class="col-sm-7">
                        {if $params.configoptions.swap == '1:1'}
                            {$params.configoptions_upgrade.memory} MB (与内存对等)
                        {elseif $params.configoptions.swap == '0'}
                            不分配
                        {else}
                            {$params.configoptions.swap} MB
                        {/if}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>磁盘空间 (系统盘):</strong></div>
                    <div class="col-sm-7">{$params.configoptions_upgrade.disk} GB</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>操作系统模板:</strong></div>
                    <div class="col-sm-7">{$params.configoptions_upgrade.os}</div>
                </div>
                <hr>
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>主IPv4地址:</strong></div>
                    <div class="col-sm-7">{$params.dedicatedip}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>服务状态:</strong></div>
                    <div class="col-sm-7">
                        {if $params.status == "Active"}
                            <span class="badge badge-success">有效</span>
                        {elseif $params.status == "Suspended"}
                            <span class="badge badge-warning">暂停</span>
                        {elseif $params.status == "Terminated"}
                             <span class="badge badge-danger">终止</span>
                        {else}
                            <span class="badge badge-secondary">{$params.status}</span>
                        {/if}
                    </div>
                </div>
                 <div class="row mb-2">
                    <div class="col-sm-5"><strong>注册日期:</strong></div>
                    <div class="col-sm-7">{$params.regdate}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-5"><strong>到期日期:</strong></div>
                    <div class="col-sm-7">{$params.nextduedate}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function formatUptimeToHuman(seconds) {
        if (isNaN(seconds) || seconds < 0) return "N/A";
        let d = Math.floor(seconds / (3600 * 24));
        let h = Math.floor((seconds % (3600 * 24)) / 3600);
        let m = Math.floor((seconds % 3600) / 60);
        let s = Math.floor(seconds % 60);
        
        let parts = [];
        if (d > 0) parts.push(d + "天");
        if (h > 0) parts.push(h + "小时");
        if (m > 0) parts.push(m + "分钟");
        if (s > 0 || parts.length === 0) parts.push(s + "秒"); // Show seconds if other parts are zero or if it's less than a minute

        return parts.join(" ");
    }

    function formatBytesToMB(bytes) {
        if (isNaN(bytes) || bytes < 0) return '0';
        return (bytes / 1024 / 1024).toFixed(0);
    }
    function formatBytesToGB(bytes) {
        if (isNaN(bytes) || bytes < 0) return '0';
        return (bytes / 1024 / 1024 / 1024).toFixed(2);
    }

    function calculatePercentage(current, max) {
        if (isNaN(current) || isNaN(max) || max == 0) return '0.00';
        return ((current / max) * 100).toFixed(2);
    }

    function refreshServerStatusInfoPage() {
        $('#server_status_loading_info').show();
        $('#server_status_content_info').hide();

        $.post("{$MODULE_CUSTOM_API}", { func: "Getcurrent" }, function(response) {
            $('#server_status_loading_info').hide();
            $('#server_status_content_info').show();

            if (response.success && response.data) {
                const data = response.data;
                $('#info_vmid_val').text(data.vmid || 'N/A');
                $('#info_name_val').text(data.name || 'N/A');
                $('#info_node_val').text(data.node || 'N/A');
                
                let statusText = '未知';
                let statusClass = 'text-secondary';
                if (data.status === 'running') {
                    statusText = '运行中';
                    statusClass = 'badge badge-success';
                } else if (data.status === 'stopped') {
                    statusText = '已关机';
                    statusClass = 'badge badge-danger';
                } else {
                    statusText = data.status || '未知';
                     statusClass = 'badge badge-secondary';
                }
                $('#info_status_text_val').html('<span class="' + statusClass + '">' + statusText + '</span>');

                $('#info_cpu_usage_val').text(data.cpu ? (data.cpu * 100).toFixed(2) : '0.00');
                
                const memUsedMB = formatBytesToMB(data.mem);
                const memMaxMB = formatBytesToMB(data.maxmem);
                $('#info_mem_usage_val').text(memUsedMB);
                $('#info_mem_max_val').text(memMaxMB);
                $('#info_mem_percent_val').text(calculatePercentage(data.mem, data.maxmem));

                const swapUsedMB = formatBytesToMB(data.swap);
                const swapMaxMB = formatBytesToMB(data.maxswap);
                $('#info_swap_usage_val').text(swapUsedMB);
                $('#info_swap_max_val').text(swapMaxMB);
                $('#info_swap_percent_val').text(calculatePercentage(data.swap, data.maxswap));
                
                const diskUsedGB = formatBytesToGB(data.disk);
                const diskMaxGB = formatBytesToGB(data.maxdisk);
                $('#info_disk_usage_val').text(diskUsedGB);
                $('#info_disk_max_val').text(diskMaxGB);
                $('#info_disk_percent_val').text(calculatePercentage(data.disk, data.maxdisk));

                $('#info_uptime_val').text(formatUptimeToHuman(data.uptime));
            } else {
                $('#info_status_text_val').html('<span class="badge badge-danger">加载失败</span>');
                if (response.message) {
                    Swal.fire("获取状态错误", response.message, "error");
                }
            }
        }).fail(function() {
            $('#server_status_loading_info').hide();
            $('#server_status_content_info').show();
            $('#info_status_text_val').html('<span class="badge badge-danger">网络错误</span>');
            Swal.fire("网络错误", "请求后端接口失败，请检查网络连接或联系管理员。", "error");
        });
    }

    $(document).ready(function() {
        refreshServerStatusInfoPage();
    });
</script>
