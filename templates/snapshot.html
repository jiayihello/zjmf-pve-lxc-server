<div class="row">
    <div class="col-xl-12 col-xs-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">快照列表</h6>
            </div>
            <div class="card-body table-responsive mx-table">
                {if $error_message}
                     <div class="alert alert-danger">{$error_message}</div>
                {else}
                    <button type="button" class="btn btn-success sm-text text-uppercase mb-2" data-toggle="modal" data-target="#create_snapshot_modal">新建快照</button>
                    {if empty($snapshots) && !$error_message}
                        <p>当前没有快照。</p>
                    {else}
                    <table class="table table-hover t-text-dark--light-15 sm-text">
                        <thead>
                        <tr>
                            <th>快照名称</th>
                            <th>创建日期</th>
                            <th>包含内存</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody class="t-mt-15">
                        {foreach $snapshots as $snapshot}
                        <tr>
                            <td>{$snapshot.name}</td>
                            <td>{if $snapshot.snaptime}{$snapshot.snaptime|date_format:"%Y-%m-%d %H:%M:%S"}{else}N/A{/if}</td>
                            <td>{if $snapshot.vmstate}是{else}否{/if}</td>
                            <td>{$snapshot.description}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        操作
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="javascript:void(0);" onclick="rollbackSnapshot('{$snapshot.name}')">回滚到此快照</a>
                                        <a class="dropdown-item" href="javascript:void(0);" onclick="deleteSnapshot('{$snapshot.name}')">删除快照</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {/foreach}
                        </tbody>
                    </table>
                    {/if}
                {/if}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="create_snapshot_modal" tabindex="-1" role="dialog" aria-labelledby="createSnapshotModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createSnapshotModalLabel">创建快照</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="create_snapshot_form">
                    <div class="form-group">
                        <label for="snapshot_name_input">快照名称</label>
                        <input type="text" class="form-control" id="snapshot_name_input" name="name" placeholder="例如: backup_月初" required pattern="^[a-zA-Z0-9_][a-zA-Z0-9_-]{0,63}$">
                        <small class="form-text text-muted">1-64字符，允许字母、数字、下划线、连字符，不能以连字符开头。</small>
                    </div>
                    <div class="form-group">
                        <label for="snapshot_description_input">描述</label>
                        <textarea class="form-control" id="snapshot_description_input" name="description" rows="3" placeholder="简要描述此快照内容 (最多250字符)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="createSnapshot()">创建</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function createSnapshot() {
        var snapshotName = document.getElementById('snapshot_name_input').value;
        var snapshotDescription = document.getElementById('snapshot_description_input').value;

        if (!snapshotName.match(/^[a-zA-Z0-9_][a-zA-Z0-9_-]{0,63}$/)) {
            Swal.fire("错误", "快照名称不符合规范。", "error");
            return;
        }
        if (snapshotDescription.length > 250) {
            Swal.fire("错误", "快照描述过长 (最多250字符)。", "error");
            return;
        }

        var payload = {
            func: "create_snapshot",
            name: snapshotName,
            description: snapshotDescription
        };

        $.post("{$MODULE_CUSTOM_API}", payload, function(response) {
            if (response.success) {
                Swal.fire("成功", response.message || "快照创建成功", "success").then(function() {
                    location.reload();
                });
            } else {
                Swal.fire("失败", response.message || "创建快照失败", "error");
            }
        }).fail(function() {
            Swal.fire("网络错误", "请求后端接口失败", "error");
        });
    }

    function rollbackSnapshot(snapshotName) {
        Swal.fire({
            title: '确认回滚?',
            html: "您确定要将容器回滚到快照 <strong>" + snapshotName + "</strong> 吗？<br/>当前容器状态将被覆盖，此操作不可恢复！<br/>回滚成功后可能需要手动启动容器。",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '是的，回滚!',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                var payload = {
                    func: "RollBACK_snapshot",
                    name: snapshotName
                };
                $.post("{$MODULE_CUSTOM_API}", payload, function(response) {
                    if (response.success) {
                        Swal.fire("成功!", response.message || "快照已开始回滚。", "success").then(function() {
                            location.reload();
                        });
                    } else {
                        Swal.fire("回滚失败!", response.message || "回滚操作失败。", "error");
                    }
                }).fail(function() {
                    Swal.fire("网络错误", "请求后端接口失败", "error");
                });
            }
        });
    }

    function deleteSnapshot(snapshotName) {
        Swal.fire({
            title: '确认删除?',
            text: "您确定要删除快照 " + snapshotName + " 吗？此操作不可恢复!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '是的，删除它!',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                var payload = {
                    func: "delete_snapshot",
                    name: snapshotName
                };
                $.post("{$MODULE_CUSTOM_API}", payload, function(response) {
                    if (response.success) {
                        Swal.fire("已删除!", response.message || "快照已删除。", "success").then(function() {
                            location.reload();
                        });
                    } else {
                        Swal.fire("删除失败!", response.message || "删除快照时发生错误。", "error");
                    }
                }).fail(function() {
                    Swal.fire("网络错误", "请求后端接口失败", "error");
                });
            }
        });
    }
</script>
